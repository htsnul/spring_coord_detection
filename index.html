<!DOCTYPE html>
<input type="file">
<div style="position: relative; border: 1px;">
</div>
<script>
  let audioCtx;
  let audioBufferSourceNode;
  let oscillatorCount = 80;
  let audioBuffer;
  let audioData;
  let t = 0;
  class Oscillator {
    constructor(parentElm, sampleRate, scale) {
      this.y = 0;
      this.v = 0;
      const f = Math.pow(2, (scale / 12) - 3) * 440 / sampleRate;
      const omega = 2 * Math.PI * f;
      this.k = 0.5;
      this.m = this.k / Math.pow(omega, 2);
      this.b = 0.5;
      this.elm = document.createElement("div");
      const noteChar = "A BC D EF G "[(240 + scale) % 12];
      this.elm.style.position = "absolute";
      this.elm.style.fontSize = "8px";
      this.elm.style.left = `${8 * scale}px`;
      this.elm.style.width = "7px";
      this.elm.style.height = "16px";
      this.elm.style.backgroundColor = (noteChar === " ") ? "#444" : "#fff";
      this.elm.style.color = "#ccc";
      this.elm.style.border = "1px solid #888";
      parentElm.appendChild(this.elm);
    }
    update(audioData, index, count) {
      let ymax = 0;
      for (let i = 0; i < count; ++i) {
        const sample = audioData[index + i];
        const a = 0.5 * sample - this.k * this.y - this.b * this.v;
        this.v += a / this.m;
        this.y += this.v;
        ymax = Math.max(ymax, Math.abs(this.y));
      }
      this.elm.style.height = `${16 + 40 * ymax}px`;
    }
  };
  let oscillators = [];
  function update() {
    requestAnimationFrame(update);
    if (!audioData) {
      return;
    }
    const count = Math.min(audioBuffer.sampleRate / 60, audioData.length - t);
    for (let j = 0; j < oscillatorCount; ++j) {
      oscillators[j].update(audioData, t, count);
    }
    t += count;
  }
  async function onFileChange(e) {
    if (!audioCtx) {
      audioCtx = new AudioContext();
    }
    if (audioBufferSourceNode) {
      audioBufferSourceNode.stop();
    }
    audioBufferSourceNode = audioCtx.createBufferSource();
    const file = e.target.files[0];
    const fileReader = new FileReader();
    fileReader.readAsArrayBuffer(file);
    await new Promise((resolve) => fileReader.onload = (e) => resolve());
    audioBufferSourceNode.buffer = await new Promise((resolve) => {
      audioCtx.decodeAudioData(fileReader.result, (buffer) => {
        resolve(buffer);
      });
    });
    audioBufferSourceNode.connect(audioCtx.destination);
    audioBuffer = audioBufferSourceNode.buffer;
    console.log(audioBuffer);
    audioData = audioBuffer.getChannelData(0);
    const divElm = document.querySelector("div");
    divElm.innerHTML = "";
    oscillators = [];
    for (let i = 0; i < oscillatorCount; ++i) {
      oscillators.push(new Oscillator(divElm, audioBuffer.sampleRate, i));
    }
    audioBufferSourceNode.start(0);
    t = 0;
  }
  onload = () => {
    requestAnimationFrame(update);
    document.querySelector("input").onchange = onFileChange;
  };
</script>
